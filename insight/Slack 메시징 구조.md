### ✅ 구조 개요

![Slack_message_1.png](../.images/Slack_message_1.png)

Channel Server
- 슬랙에 있는 채널과 관련된 서버
- 각 채널에 대한 정보 보관
- 특정 채널이 어떤 채널 서버로 할당이 되는지에 대한 정보 → 안정 해시 기법을 이용하여 해싱 처리하여 지정함
- 하나의 호스트 당 최대 1600백만 채널 제공
- 해시는 누가 관리? → 채널과 그 채널에 따른 안정 해시를 관리하는 서버가 따로 있는데 그게 바로 CHARM Server

CHARM Server
- Consistent hash ring managers
- CS(Channel Server)를 위한 해시 값 관리
- 하나의 CS가 불안정할 때 그를 대체하는 CS를 하나 만드는데, 약 20초 이내에 교체가 진행됨

Admin Server
- 웹앱 서버와 CS를 중간에 연결해주는 역할

Gateway Server
- 슬랙 클라이언트와 실제 연결되게 되는 서버
→ 슬랙 클라이언트가 GS에 붙으면 그 GS 서버는 다시 여러개의 CS를 구독하는 형태로 동작
- 사용자 정보 저장 
- 웹소켓의 채널 구독 상태 저장 
- GS는 여러 지역 리전에 분산되어 위치함
 → 따라서 슬랙 클라이언트가 가장 가까운 리전의 GS에 연결됨


### ✅ 클라이언트 연결

![Slack_message_2.png](../.images/Slack_message_2.png)

1. 슬랙 클라이언트가 가장 먼저 하는 것은 웹앱 서버에 연결하여 사용자 정보를 읽어온다.
    - 이 웹앱 서버가 일종의 API 서버 역할
    - 웹앱 서버는 슬랙 클라이언트가 렌더링하는데 필요한 JS 파일 등의 코드도 포함하고 있다.
2. 가까운 지역 Edge Region 내 Envoy 서버에 웹소켓 연결 한다.
3. 그 Envoy 서버는 다시 Gateway 서버에 붙게 된다.
4. Gateway 서버는 사용자 정보를 읽어오기 위해 웹앱 서버를 호출하여 그 사용자에 해당하는 채널 목록들을 읽어온다.
5. Gateway 서버는 다시 Envoy 서버에 정보를 주고, Hello 재연결 확인한다.
6. 다시 Envoy 서버는 슬랙 클라이언트에 그 정보를 전달한다.
7. 그리고 나서 알맞은 채널 서버를 구독한다. 채널마다 채널 서버가 할당이 되기 때문에 **Gateway 서버는 여러 채널 서버를 구독**한다.
8. 이렇게하면 클라이언트가 메시지를 주고 받을 수 있는 상태가 된 것이다.

### ✅ 메시지 전송

![Slack_message_3.png](../.images/Slack_message_3.png)

1. 슬랙 클라이언트가 메시지를 전송한다. → 웹앱 서버가 제공하는 API 이용
2. 웹앱 서버는 메시지를 저장한다.
3. 웹앱 서버는 어드민 서버에 채널 메시지 전송 요청을 한다.
4. 어드민 서버가 알맞은 채널 서버를 찾아서 메시징을 라우팅한다.
5. 채널 서버는 자신을 구독하고 있던 게이트웨이 서버한테 메시지가 왔다고 전송을 한다. (그림의 경우 5B, 5C 두 게이트웨이 서버에 전송)
6. 게이트웨이 서버는 다시 엔보이 서버한테 전달을 한다.
7. 엔보이 서버는 최종적으로 슬랙 클라이언트한테 메시지를 전송한다.

### ✅ 이벤트 전송

![Slack_message_4.png](../.images/Slack_message_4.png)

실제 슬랙에는 슬랙 메시지를 주고받는 것뿐만 아니라 이벤트라고 설명된 이벤트 종류도 있다. 약간의 휘발성 메시지 혹은 정해진 주기로 실행되는 것에 따라 생기는 메시지를 이벤트라고 슬랙 블로그에서는 정리하고 있다.

- 슬랙에서 **님이 메시지 입력 중과 같이 입력중 상태 보이는 것
- **님이 ##채널에 참여했습니다 등의 메시지

이벤트는 웹앱을 호출하지 않는다. → 저장하지 않는 것!

1. 엔보이 서버에 바로 메시지 전송
2. 게이트웨이 서버한테 해당 메시지 전송
3. 게이트웨이 서버는 채널 서버에 메시지 라우팅 → 이 메시지 보내줘~
4. 채널 서버가 구독된 게이트웨이 서버에게 메시지 전송
5. 게이트웨이 서버는 엔보이서버에 메시지 전송
6. 엔보이가 최종적으로 슬랙 클라이언트에게 전달

### ✅ 정리

이런 구조를 통해서

- 하나의 호스트 당 약 천만 채널을 처리중
- 수 천만의 연결된 클라이언트 처리중
- 500ms 내에 전 세계로 메시지 전송 가능
- 선형적으로 확장 가능한 아키텍처 → 채널 서버를 수평 확장

[🔗 출처 링크](https://www.youtube.com/watch?v=36F35JZXFKo)